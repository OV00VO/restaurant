<!-- Reference: Code Institute Curriculum and Code Star Project -->
<!-- Reference: https://github.com/flatplanet/Django-CRM -->
<!-- Reference: https://getbootstrap.com -->
<!-- Reference: https://developer.mozilla.org/en-US/docs/Learn/Forms/Form_validation -->
<!-- Reference: https://www.w3schools.com/js/js_validation.asp -->
<!-- Reference: https://regex101.com/r/TGpiRb/1/codegen?language=python -->
<!-- Reference: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions -->
<!-- Reference: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date -->
<!-- Reference: https://www.w3schools.com/js/js_dates.asp -->
<!-- Reference: https://formvalidation.io/guide/validators/ -->
<!-- Reference: https://jqueryvalidation.org -->
<!-- Notes: Below code is based on the above references and modifed for the project -->
<!DOCTYPE html>
<html class="h-100" lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Restaurant - Fine Dine - Base</title>
  <link rel="icon" type="image/x-icon" href="https://asset.cloudinary.com/dpp16gilv/97612c82a1687b7005f1d5a26d1ac2b7">
  <meta name="description" content="Secure your table at our fine-dining restaurant! Book your reservation online quickly and easily. Enjoy an unforgettable culinary experience.">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-timepicker/0.5.2/css/bootstrap-timepicker.min.css" rel="stylesheet">
</head>

{% load static %}
{% load crispy_forms_tags %}

<!-- Reference in modified parts below: https://github.com/flatplanet/Django-CRM -->
    {% include 'navbar.html' %}
{% if user.is_authenticated %}
{% else %}
{% endif %}
      {% block content %}
      {% endblock%}
      {% include 'footer.html' %}
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-timepicker/0.5.2/js/bootstrap-timepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
      
    <script>
      function openPopup(event) {
        event.preventDefault();
        const form = document.getElementById('reservation-form');
        const formData = new FormData(form);
        const queryString = new URLSearchParams(formData).toString();
        window.open(`https://formdump.codeinstitute.net?${queryString}`, "popup", "width=600,height=400");
      }
    </script>

<!-- Reference: https://www.w3schools.com/js/js_validation.asp -->
<!-- Reference: https://regex101.com/r/TGpiRb/1/codegen?language=python -->
<!-- Reference: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions -->
<!-- Reference: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date -->
<!-- Reference: https://www.w3schools.com/js/js_dates.asp -->
<!-- Reference: https://formvalidation.io/guide/validators/ -->
<!-- Reference: https://jqueryvalidation.org -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('reservation-form');
        const submitButton = document.getElementById('submit-btn');
        const termsCheckbox = document.getElementById('id_agreed_to_terms');
        
        const openingHours = {
          1: '11:30-14:00,18:00-23:00', // Monday
          2: '11:30-14:00,18:00-23:00', // Tuesday
          3: '11:30-14:00,18:00-23:00', // Wednesday
          4: '11:30-14:00,18:00-23:00', // Thursday
          5: '11:30-14:00,18:00-02:00', // Friday
          6: '18:00-02:00',             // Saturday
          0: 'closed'                   // Sunday
        };
    
        function validateName(name) {
          return name.trim().split(' ').length >= 2;
        }
    
        function validatePhone(phone) {
          const phoneNumberPattern = /^\+?[0-9]{10,15}$/;
          return phoneNumberPattern.test(phone);
        }
    
        function validateEmail(email) {
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailPattern.test(email);
        }
    
        function validateGuests(numGuests) {
          return !isNaN(numGuests) && numGuests >= 1 && numGuests <= 500;
        }
    
        function validateDate(selectedDate) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          const selected = new Date(selectedDate);
          selected.setHours(0, 0, 0, 0);

          return selected > today && selected.getDay() !== 0;
        }
    
        function getAvailableTimeSlots(openingTimes) {
          return openingTimes.flatMap(period => {
            const [start, end] = period.split('-');
            return generateTimeSlots(start, end);
          });
        }
    
        function generateTimeSlots(start, end) {
          const slots = [];
          const startMinutes = timeToMinutes(start);
          const endMinutes = timeToMinutes(end);
          for (let minutes = startMinutes; minutes <= endMinutes; minutes += 15) {
            const hour = Math.floor(minutes / 60);
            const minute = minutes % 60;
            slots.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
          }
          return slots;
        }
    
        function validateTime(selectedTime, openingHours, dayOfWeek) {
          if (!openingHours[dayOfWeek] || openingHours[dayOfWeek] === 'closed') {
            return false;
          }
    
          const openingTimes = openingHours[dayOfWeek].split(',');
          const availableTimeSlots = getAvailableTimeSlots(openingTimes);
    
          const now = new Date();
          const selectedMinutes = timeToMinutes(selectedTime);
          const currentMinutes = timeToMinutes(now.toTimeString().slice(0, 5));
          const isToday = now.toDateString() === new Date(document.getElementById('id_date').value).toDateString();
    
          if (isToday && selectedMinutes < currentMinutes) {
            return false;
          }
    
          let closestTimeSlot = availableTimeSlots[0];
          let minDifference = Infinity;
          
          availableTimeSlots.forEach(slot => {
            const slotMinutes = timeToMinutes(slot);
            const difference = Math.abs(selectedMinutes - slotMinutes);
            if (difference < minDifference) {
              minDifference = difference;
              closestTimeSlot = slot;
            }
          });
    
          const lastPeriod = openingTimes[openingTimes.length - 1].split('-');
          const closingTimeMinutes = timeToMinutes(lastPeriod[1]) - 30;
          
          return selectedMinutes <= closingTimeMinutes ? closestTimeSlot : null;
        }
    
        function timeToMinutes(time) {
          const [hour, minute] = time.split(':').map(Number);
          return hour * 60 + minute;
        }
    
        function roundToNearestQuarterHour(time) {
          const [hour, minute] = time.split(':').map(Number);
          const totalMinutes = hour * 60 + minute;
          const roundedMinutes = Math.round(totalMinutes / 15) * 15;
          const roundedHour = Math.floor(roundedMinutes / 60);
          const roundedMinute = roundedMinutes % 60;
          return `${roundedHour.toString().padStart(2, '0')}:${roundedMinute.toString().padStart(2, '0')}`;
        }
    
        function updateSubmitButton() {
          submitButton.disabled = !termsCheckbox.checked;
        }
    
        termsCheckbox.addEventListener('change', updateSubmitButton);
    
        form.addEventListener('submit', function(event) {
          const name = document.getElementById('id_name').value;
          const email = document.getElementById('id_email').value;
          const phone = document.getElementById('id_phone_number').value;
          const numGuests = parseInt(document.getElementById('id_number_of_guests').value, 10);
          const selectedDate = new Date(document.getElementById('id_date').value);
          const selectedTime = document.getElementById('id_time').value;
          const dayOfWeek = selectedDate.getDay();
    
          let isValid = true;
          const validationMessages = [];
    
          if (!validateName(name)) {
            validationMessages.push('Please enter a valid full name with a surname.');
            isValid = false;
          }
    
          if (!validateEmail(email)) {
            validationMessages.push('Please enter a valid email address.');
            isValid = false;
          }
    
          if (!validatePhone(phone)) {
            validationMessages.push('Please enter a valid phone number.');
            isValid = false;
          }
    
          if (!validateDate(selectedDate)) {
            validationMessages.push('Reservation date cannot be in the past, today, or on a Sunday.');
            isValid = false;
          }
    
          const closestTimeSlot = validateTime(selectedTime, openingHours, dayOfWeek);
          if (!closestTimeSlot) {
            validationMessages.push('Reservations are only available during the restaurant open hours, and cannot be booked for the current (Today) or any past time prior of Today. If you like to make a reservation please do not hesitate to contact us directly on phone:(0200) restaurant-fine-dine, please do not send e-mail or form request. This is for us to be able to have a guaranteed reservation and a nice table set for you at arrival.');
            isValid = false;
          } else {
            document.getElementById('id_time').value = closestTimeSlot;
          }
    
          if (!validateGuests(numGuests)) {
            if (isNaN(numGuests)) {
              validationMessages.push('Please enter a valid number of guests.');
            } else if (numGuests < 1) {
              validationMessages.push('Number of guests must be at least 1 person.');
            } else if (numGuests > 100) {
              validationMessages.push('We can only accommodate up to 100 guests for booking online. For larger parties, we can accomondate over 500 guests in our venues, please contact us directly at phone: (0200) restaurant-fine-dine or email: info@restaurantfinedine.com.');
            }
            isValid = false;
          }
    
          if (!termsCheckbox.checked) {
            validationMessages.push('You must accept the terms and conditions before submitting.');
            isValid = false;
          }
    
          if (!isValid) {
            alert(validationMessages.join('\n'));
            event.preventDefault();
          }
        });
    
        updateSubmitButton();
      });
    </script>
    
    <br><br>

  </body>
</html>