<!DOCTYPE html>
<html class="h-100" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restaurant - Fine Dine - Create Reservation</title>
  <meta name="description" content="Plan your unforgettable fine-dining experience! Book a table online at our restaurant and savor exquisite cuisine in an elegant ambiance.">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="h-100">
  {% extends 'base.html' %} 
  {% block content %}
  {% if user.is_authenticated %}
    {% load crispy_forms_tags %}
    <section class="container py-5">
      <h2>Welcome, {{ user.username }}!</h2>
  {% endif %}

    <h2>Please Create Your Next Reservation Here!</h2>
    <form id="reservation-form" method="POST" action="{% url 'create_reservation' %}">
      {% csrf_token %}
      {{ form|crispy }}
      <a href="/agreed_to_terms" target="_blank">Read Terms and Conditions</a>
      <div class="row">
        <div class="col-12 text-center mt-3">
          <button type="submit" class="btn btn-primary" id="submit-btn" disabled>Create Reservation</button>
          <a href="/my_reservations" class="btn btn-success">Back to Your Reservations</a>
        </div>
      </div>
    </form>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('reservation-form');
      const submitButton = document.getElementById('submit-btn');
      const termsCheckbox = document.getElementById('id_agreed_to_terms');
      
      const openingHours = {
        1: '11:30-14:00,18:00-23:00', // Monday
        2: '11:30-14:00,18:00-23:00', // Tuesday
        3: '11:30-14:00,18:00-23:00', // Wednesday
        4: '11:30-14:00,18:00-23:00', // Thursday
        5: '11:30-14:00,18:00-02:00', // Friday
        6: '18:00-02:00',             // Saturday
        0: 'closed'                   // Sunday
      };

      function validateName(name) {
        return name.trim().split(' ').length >= 2;
      }

      function validateEmail(email) {
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailPattern.test(email);
      }

      function validateGuests(numGuests) {
        return !isNaN(numGuests) && numGuests > 0;
      }

      function validateDate(selectedDate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return selectedDate >= today && selectedDate.getDay() !== 0;
      }

      function getAvailableTimeSlots(openingTimes) {
        return openingTimes.flatMap(period => {
          const [start, end] = period.split('-');
          return generateTimeSlots(start, end);
        });
      }

      function generateTimeSlots(start, end) {
        const slots = [];
        const startMinutes = timeToMinutes(start);
        const endMinutes = timeToMinutes(end);
        for (let minutes = startMinutes; minutes <= endMinutes; minutes += 15) {
          const hour = Math.floor(minutes / 60);
          const minute = minutes % 60;
          slots.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
        }
        return slots;
      }

      function validateTime(selectedTime, openingHours, dayOfWeek) {
        if (!openingHours[dayOfWeek] || openingHours[dayOfWeek] === 'closed') {
          return false;
        }

        const openingTimes = openingHours[dayOfWeek].split(',');
        const availableTimeSlots = getAvailableTimeSlots(openingTimes);

        const now = new Date();
        const selectedMinutes = timeToMinutes(selectedTime);
        const currentMinutes = timeToMinutes(now.toTimeString().slice(0, 5));
        const isToday = now.toDateString() === new Date(document.getElementById('id_date').value).toDateString();

        if (isToday && selectedMinutes < currentMinutes) {
          return false;
        }

        let closestTimeSlot = availableTimeSlots[0];
        let minDifference = Infinity;
        
        availableTimeSlots.forEach(slot => {
          const slotMinutes = timeToMinutes(slot);
          const difference = Math.abs(selectedMinutes - slotMinutes);
          if (difference < minDifference) {
            minDifference = difference;
            closestTimeSlot = slot;
          }
        });

        const lastPeriod = openingTimes[openingTimes.length - 1].split('-');
        const closingTimeMinutes = timeToMinutes(lastPeriod[1]) - 30;
        
        return selectedMinutes <= closingTimeMinutes ? closestTimeSlot : null;
      }

      function timeToMinutes(time) {
        const [hour, minute] = time.split(':').map(Number);
        return hour * 60 + minute;
      }

      function roundToNearestQuarterHour(time) {
        const [hour, minute] = time.split(':').map(Number);
        const totalMinutes = hour * 60 + minute;
        const roundedMinutes = Math.round(totalMinutes / 15) * 15;
        const roundedHour = Math.floor(roundedMinutes / 60);
        const roundedMinute = roundedMinutes % 60;
        return `${roundedHour.toString().padStart(2, '0')}:${roundedMinute.toString().padStart(2, '0')}`;
      }

      function updateSubmitButton() {
        submitButton.disabled = !termsCheckbox.checked;
      }

      termsCheckbox.addEventListener('change', updateSubmitButton);

      form.addEventListener('submit', function(event) {
        const name = document.getElementById('id_name').value;
        const email = document.getElementById('id_email').value;
        const numGuests = parseInt(document.getElementById('id_number_of_guests').value, 10);
        const selectedDate = new Date(document.getElementById('id_date').value);
        const selectedTime = document.getElementById('id_time').value;
        const dayOfWeek = selectedDate.getDay();

        let isValid = true;
        const validationMessages = [];

        if (!validateName(name)) {
          validationMessages.push('Please enter a valid full name with a surname.');
          isValid = false;
        }

        if (!validateEmail(email)) {
          validationMessages.push('Please enter a valid email address.');
          isValid = false;
        }

        if (!validateGuests(numGuests)) {
          validationMessages.push('Number of guests must be at least 1 person.');
          isValid = false;
        }

        if (!validateDate(selectedDate)) {
          validationMessages.push('Reservation date cannot be in the past, today, or on a Sunday.');
          isValid = false;
        }

        const closestTimeSlot = validateTime(selectedTime, openingHours, dayOfWeek);
        if (!closestTimeSlot) {
          validationMessages.push('Reservations are only available during our business hours and cannot be booked for the current or past time.');
          isValid = false;
        } else {
          document.getElementById('id_time').value = closestTimeSlot;
        }

        if (!termsCheckbox.checked) {
          validationMessages.push('You must accept the terms and conditions before submitting.');
          isValid = false;
        }

        if (!isValid) {
          alert(validationMessages.join('\n'));
          event.preventDefault();
        }
      });

      updateSubmitButton();
    });
  </script>

  {% endblock %}
</body>
</html>
